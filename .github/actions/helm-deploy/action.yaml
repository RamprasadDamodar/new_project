name: helm-deploy
description: "Execute helm package to deploy built image"
inputs:
  image-tag:
    description: "The deploying docker image tag"
    required: true           
          

runs:
  using: composite
  steps:
    - name: replace value file
      id: replace-value-file
      shell: bash
      working-directory: ./deploy/infrastore-chart
      run: |
        pwd
        sed s/%TAG%/${{ inputs.image-tag }}/g values.yaml

    - name: debug value file
      id: debug-value-file
      shell: bash
      working-directory: ./deploy/infrastore-chart
      run: |
        cat values.yaml

    - name: Commit and push changes
      id: commit-push
      shell: bash
      working-directory: ./deploy/infrastore-chart
      run: |
        git config --global user.name "RamprasadDamodar"
        git config --global user.email "Ramprasad.Damodar1989@gmail.com"
        git add .
        git commit -m "Updated image tag"
        # Create a temporary branch to save the new commit
        TEMP_BRANCH="temp-helm-update-$(date +%s)"
        git branch $TEMP_BRANCH
        
        # Check out the main branch
        git checkout main
        
        # Merge the temporary branch into main
        git merge $TEMP_BRANCH --no-ff --no-edit
        
        # Push the updated main branch to the remote
        git push origin main
        
        # (Optional) Clean up the temporary branch
        git branch -d $TEMP_BRANCH



